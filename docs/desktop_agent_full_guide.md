# å®Œæ•´å¯¼èˆªä»£ç†ä½¿ç”¨æŒ‡å—

`desktop_agent_full_example.py` æä¾›äº†å®Œæ•´çš„å¤šæ­¥éª¤æ¡Œé¢è‡ªåŠ¨åŒ–æ–¹æ¡ˆï¼ŒåŒ…å«å†å²ç®¡ç†å’Œæ‰§è¡Œåé¦ˆã€‚

---

## åŠŸèƒ½ç‰¹ç‚¹

- **å¤šæ­¥æ‰§è¡Œ**: è‡ªåŠ¨å¾ªç¯æ‰§è¡Œç›´åˆ°ä»»åŠ¡å®Œæˆ
- **å†å²ç®¡ç†**: ç»´æŠ¤å®Œæ•´çš„æ“ä½œè½¨è¿¹
- **æ‰§è¡Œåé¦ˆ**: å°†ä¸Šä¸€æ­¥ç»“æœåé¦ˆç»™æ¨¡å‹
- **é‡å¤æ£€æµ‹**: é˜²æ­¢æ— é™å¾ªç¯æ‰§è¡Œç›¸åŒåŠ¨ä½œ
- **æ—¥å¿—è®°å½•**: è‡ªåŠ¨è®°å½•åˆ° `logs/agent_*.log`

---

## å‰ç½®è¦æ±‚

### 1. å¯åŠ¨ LM Studio

1. åœ¨ LM Studio ä¸­ä¸‹è½½ MAI-UI æ¨¡å‹ï¼ˆæœç´¢ `MAI-UI` æˆ– `Tongyi-MAI`ï¼‰
2. é€‰æ‹©æ¨¡å‹åç‚¹å‡» **Server** æŒ‰é’®
3. ç¡®è®¤é…ç½®ï¼š
   - Host: `127.0.0.1`
   - Port: `1234`
4. ç‚¹å‡» **Start Server** å¯åŠ¨

### 2. å®‰è£…ä¾èµ–

```bash
pip install pyautogui pillow mss pyperclip
```

---

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```bash
cd examples
python desktop_agent_full_example.py
```

### äº¤äº’ç¤ºä¾‹

```
ğŸš€ Initializing MAI-UI Desktop Agent...
âœ“ Agent ready (logs: logs/agent_20250115_123456.log)

ğŸ’¬ Enter your instruction (or 'quit' to exit): æ‰“å¼€è®°äº‹æœ¬å¹¶è¾“å…¥Hello World

============================================================
ğŸ¯ Task: æ‰“å¼€è®°äº‹æœ¬å¹¶è¾“å…¥Hello World
============================================================

  ğŸ§  Thinking: å¯åŠ¨è®°äº‹æœ¬åº”ç”¨
  [EXECUTED] LAUNCH â†’ Launched: notepad

  ğŸ§  Thinking: åœ¨è®°äº‹æœ¬çª—å£è¾“å…¥æ–‡æœ¬
  [EXECUTED] TYPE â†’ Typed: "Hello World"

  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“‹ Task Result: å·²åœ¨è®°äº‹æœ¬ä¸­è¾“å…¥Hello World
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. MAIDesktopNavigationAgent

è´Ÿè´£åŠ¨ä½œé¢„æµ‹å’Œå†å²ç®¡ç†ï¼š

```python
agent = MAIDesktopNavigationAgent(
    llm_base_url="http://localhost:1234/v1",
    model_name="mai-ui",
    runtime_conf={
        "history_n": 3,           # å†å²æ­¥æ•°
        "temperature": 0.0,
        "max_tokens": 8192,
    },
)
```

### 2. DesktopController

è´Ÿè´£æ‰§è¡Œæ¡Œé¢åŠ¨ä½œï¼š

```python
controller = DesktopController(screen_width, screen_height)
result = controller.execute_action(action)
```

---

## æ”¯æŒçš„åŠ¨ä½œ

| åŠ¨ä½œ | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `click` | `coordinate`, `button` | å•å‡» |
| `double_click` | `coordinate`, `button` | åŒå‡» |
| `drag` | `start_coordinate`, `end_coordinate` | æ‹–æ‹½ |
| `scroll` | `coordinate`, `direction`, `amount` | æ»šåŠ¨ |
| `type` | `text` | è¾“å…¥æ–‡æœ¬ï¼ˆå‰ªè´´æ¿æ–¹å¼ï¼‰ |
| `launch` | `text` | å¯åŠ¨åº”ç”¨ |
| `wait` | `duration` | ç­‰å¾… |
| `terminate` | `status` | ä»»åŠ¡å®Œæˆ |
| `answer` | `text` | è¿”å›ç­”æ¡ˆ |

---

## æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·è¾“å…¥æŒ‡ä»¤                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æˆªå–å½“å‰å±å¹•                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è°ƒç”¨ agent.predict()                                    â”‚
â”‚     - æŒ‡ä»¤ + æˆªå›¾ + ä¸Šæ¬¡æ‰§è¡Œç»“æœ                            â”‚
â”‚     - è¿”å›: (prediction, action)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ£€æŸ¥åŠ¨ä½œç±»å‹                                             â”‚
â”‚     - terminate/answer â†’ ä»»åŠ¡å®Œæˆï¼Œé€€å‡ºå¾ªç¯                 â”‚
â”‚     - å…¶ä»–åŠ¨ä½œ â†’ ç»§ç»­æ‰§è¡Œ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. controller.execute_action(action)                       â”‚
â”‚     - æ‰§è¡Œæ¡Œé¢æ“ä½œ                                           â”‚
â”‚     - è¿”å›æ‰§è¡Œç»“æœ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ç­‰å¾…åŠ¨ä½œå®Œæˆ                                             â”‚
â”‚     - launch: 3ç§’                                          â”‚
â”‚     - click: 1.5ç§’                                         â”‚
â”‚     - type: 0.5ç§’                                          â”‚
â”‚     - å…¶ä»–: 0.8ç§’                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. è¿”å›æ­¥éª¤ 2ï¼ˆæœ€å¤šæ‰§è¡Œ 20 æ­¥ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç ç”¨æ³•

### åŸºæœ¬ä½¿ç”¨

```python
from mai_desktop_navigation_agent import MAIDesktopNavigationAgent
from desktop_agent_full_example import DesktopController
import mss
from PIL import Image

# åˆå§‹åŒ–
agent = MAIDesktopNavigationAgent(
    llm_base_url="http://localhost:1234/v1",
    model_name="mai-ui",
)
controller = DesktopController(1920, 1080)

# æ‰§è¡Œä»»åŠ¡
instruction = "æ‰“å¼€è®°äº‹æœ¬å¹¶è¾“å…¥Hello World"
max_steps = 20

for step in range(max_steps):
    # æˆªå›¾
    with mss.mss() as sct:
        monitor = sct.monitors[1]
        screenshot = sct.grab(monitor)
        img = Image.frombytes("RGB", screenshot.size, screenshot.rgb)

    # é¢„æµ‹
    prediction, action = agent.predict(
        instruction=instruction,
        obs={
            "screenshot": img,
            "execution_result": "",  # ä¸Šæ¬¡æ‰§è¡Œç»“æœ
        }
    )

    # æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if action.get("action") in ["terminate", "answer"]:
        print(f"ä»»åŠ¡å®Œæˆ: {action.get('text')}")
        break

    # æ‰§è¡Œ
    result = controller.execute_action(action)
    print(f"[EXECUTED] {action.get('action')} â†’ {result}")
```

---

## åé¦ˆæœºåˆ¶

æ¯æ¬¡é¢„æµ‹æ—¶å¯ä»¥å°†ä¸Šä¸€æ¬¡çš„æ‰§è¡Œç»“æœä¼ é€’ç»™æ¨¡å‹ï¼š

```python
last_execution_result = ""

for step in range(max_steps):
    prediction, action = agent.predict(
        instruction=instruction,
        obs={
            "screenshot": screenshot,
            "execution_result": last_execution_result,  # åé¦ˆä¸Šæ¬¡ç»“æœ
        }
    )

    result = controller.execute_action(action)
    last_execution_result = result  # ä¿å­˜ä¾›ä¸‹æ¬¡ä½¿ç”¨
```

---

## é…ç½®é€‰é¡¹

### Agent é…ç½®

```python
agent = MAIDesktopNavigationAgent(
    llm_base_url="http://localhost:1234/v1",
    model_name="mai-ui",
    runtime_conf={
        "history_n": 3,           # ä¿ç•™çš„å†å²æ­¥æ•°
        "temperature": 0.0,       # é‡‡æ ·æ¸©åº¦
        "top_k": -1,              # Top-k é‡‡æ ·
        "top_p": 1.0,             # Top-p é‡‡æ ·
        "max_tokens": 8192,       # æœ€å¤§è¾“å‡ºé•¿åº¦
    },
    mcp_tools=[...]              # å¯é€‰ï¼šMCP å·¥å…·åˆ—è¡¨
)
```

### æ‰§è¡Œå™¨é…ç½®

```python
import pyautogui

pyautogui.PAUSE = 0.5        # æ¯ä¸ªåŠ¨ä½œé—´éš”
pyautogui.FAILSAFE = True    # ç´§æ€¥ç»ˆæ­¢ï¼ˆç§»åŠ¨é¼ æ ‡åˆ°è§’è½ï¼‰
```

---

## æ—¥å¿—æ–‡ä»¶

æ—¥å¿—è‡ªåŠ¨ä¿å­˜åˆ° `logs/` ç›®å½•ï¼š

```
logs/agent_20250115_123456.log
```

æ—¥å¿—å†…å®¹åŒ…å«ï¼š
- æ¯ä¸€æ­¥çš„è¾“å…¥æ¶ˆæ¯
- æ¨¡å‹åŸå§‹è¾“å‡º
- è§£æåçš„åŠ¨ä½œ
- æ‰§è¡Œç»“æœ

---

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è°ƒæ•´æœ€å¤§æ­¥æ•°ï¼Ÿ

A: ä¿®æ”¹ `max_steps` å˜é‡ï¼š

```python
max_steps = 30  # å¢åŠ åˆ° 30 æ­¥
```

### Q: ä¸ºä»€ä¹ˆä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Ÿ

A: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼š

```bash
cat logs/agent_*.log
```

### Q: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰åº”ç”¨å¯åŠ¨ï¼Ÿ

A: ä¿®æ”¹ `_launch()` æ–¹æ³•ä¸­çš„ `app_commands` å­—å…¸ï¼š

```python
app_commands = {
    "myapp": r"C:\Path\To\myapp.exe",
}
```

---

## é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æ¨èä½¿ç”¨ |
|------|----------|
| å¤šæ­¥éª¤å¤æ‚ä»»åŠ¡ | âœ… æ¨è |
| éœ€è¦å†å²ä¸Šä¸‹æ–‡ | âœ… æ¨è |
| éœ€è¦æ‰§è¡Œåé¦ˆ | âœ… æ¨è |
| ç®€å•å•æ­¥æ“ä½œ | âŒ å»ºè®®ä½¿ç”¨ `oneshot_agent_example.py` |
